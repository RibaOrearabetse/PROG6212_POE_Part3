@model IEnumerable<Contract_Monthly_Claim_System__CMCS_.Models.Claim>
@{
    ViewData["Title"] = "Pending Claims for Approval";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-clipboard-check me-2 text-primary"></i>
                        All Claims for Review
                    </h2>
                    <p class="text-muted mb-0">Review and manage all submitted claims (Pending, Approved, and Rejected)</p>
                </div>
                <div class="badge bg-primary fs-6">
                    <i class="fas fa-list me-1"></i>
                    @Model.Count() Total Claims
                </div>
            </div>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["InfoMessage"] != null)
    {
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <i class="fas fa-info-circle me-2"></i>
            @TempData["InfoMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (Model != null && Model.Any())
    {
        <div class="row">
            @foreach (var claim in Model)
            {
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="card h-100 shadow-sm border-0" data-claim-id="@claim.ClaimID">
                        <div class="card-header bg-light border-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0 text-primary">
                                    <i class="fas fa-file-invoice me-2"></i>
                                    Claim #@claim.ClaimID
                                </h5>
                                @if (claim.ClaimStatus == "Pending")
                                {
                                    <span class="badge bg-warning text-dark">
                                        <i class="fas fa-clock me-1"></i>
                                        Pending
                                    </span>
                                }
                                else if (claim.ClaimStatus == "Approved")
                                {
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>
                                        Approved
                                    </span>
                                }
                                else if (claim.ClaimStatus == "Rejected")
                                {
                                    <span class="badge bg-danger">
                                        <i class="fas fa-times me-1"></i>
                                        Rejected
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-info-circle me-1"></i>
                                        @claim.ClaimStatus
                                    </span>
                                }
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-6">
                                    <small class="text-muted">Claim Date</small>
                                    <div class="fw-bold">@claim.ClaimDate.ToString("MMM dd, yyyy")</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Submitted</small>
                                    <div class="fw-bold">@claim.SubmissionDate.ToString("MMM dd, yyyy")</div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-6">
                                    <small class="text-muted">Hours Worked</small>
                                    <div class="fw-bold">@claim.HoursWorked hours</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Hourly Rate</small>
                                    <div class="fw-bold">R @claim.HourlyRate.ToString("N2")</div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <small class="text-muted">Total Amount</small>
                                <div class="h5 text-success fw-bold" data-amount="R @claim.TotalAmount.ToString("N2")">R @claim.TotalAmount.ToString("N2")</div>
                            </div>

                            @if (!string.IsNullOrEmpty(claim.Notes))
                            {
                                <div class="mb-3">
                                    <small class="text-muted">Notes</small>
                                    <div class="text-muted small">@claim.Notes</div>
                                </div>
                            }

                            <div class="mb-3">
                                <small class="text-muted">User ID</small>
                                <div class="fw-bold">@claim.UserID</div>
                            </div>
                        </div>
                        <div class="card-footer bg-light border-0">
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                @if (claim.ClaimStatus == "Pending")
                                {
                                    <button type="button" class="btn btn-success btn-sm approve-btn" data-claim-id="@claim.ClaimID" data-amount="R @claim.TotalAmount.ToString("N2")">
                                        <i class="fas fa-check me-1"></i>
                                        Approve
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm reject-btn" data-claim-id="@claim.ClaimID" data-amount="R @claim.TotalAmount.ToString("N2")">
                                        <i class="fas fa-times me-1"></i>
                                        Reject
                                    </button>
                                }
                                else if (claim.ClaimStatus == "Approved")
                                {
                                    <div class="text-success">
                                        <i class="fas fa-check-circle me-1"></i>
                                        Claim Approved
                                    </div>
                                }
                                else if (claim.ClaimStatus == "Rejected")
                                {
                                    <div class="text-danger">
                                        <i class="fas fa-times-circle me-1"></i>
                                        Claim Rejected
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="text-center py-5">
            <div class="mb-4">
                <i class="fas fa-clipboard-list fa-4x text-muted"></i>
            </div>
            <h4 class="text-muted">No Claims Found</h4>
            <p class="text-muted">There are currently no claims to review.</p>
            <a asp-controller="Claim" asp-action="Create" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>
                Submit New Claim
            </a>
        </div>
    }
</div>

<!-- Hidden form for anti-forgery token -->
<form style="display: none;" id="antiForgeryForm">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script>
        // Get anti-forgery token once
        function getAntiForgeryToken() {
            const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            return tokenInput ? tokenInput.value : '';
        }

        // Handle approve button clicks
        document.addEventListener('click', function(e) {
            if (e.target.closest('.approve-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const button = e.target.closest('.approve-btn');
                const claimId = parseInt(button.getAttribute('data-claim-id'));
                const amount = button.getAttribute('data-amount');
                
                if (!confirm(`Are you sure you want to approve Claim #${claimId} for ${amount}?`)) {
                    return false;
                }

                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Approving...';

                const formData = new FormData();
                formData.append('claimId', claimId.toString());
                formData.append('comments', 'Approved by coordinator/manager');
                formData.append('__RequestVerificationToken', getAntiForgeryToken());

                fetch('/Approval/ApproveClaim', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSuccessMessage(`Claim #${claimId} approved successfully!`);
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showErrorMessage(data.message || 'Failed to approve claim');
                        button.disabled = false;
                        button.innerHTML = originalText;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showErrorMessage('Error approving claim');
                    button.disabled = false;
                    button.innerHTML = originalText;
                });
                return false;
            }
            
            if (e.target.closest('.reject-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const button = e.target.closest('.reject-btn');
                const claimId = parseInt(button.getAttribute('data-claim-id'));
                const amount = button.getAttribute('data-amount');
                
                const reason = prompt(`Please provide a reason for rejecting Claim #${claimId} for ${amount}:`);
                if (reason === null) {
                    return false;
                }
                
                if (reason.trim() === '') {
                    alert('Please provide a reason for rejection');
                    return false;
                }

                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Rejecting...';

                const formData = new FormData();
                formData.append('claimId', claimId.toString());
                formData.append('comments', reason);
                formData.append('__RequestVerificationToken', getAntiForgeryToken());

                fetch('/Approval/RejectClaim', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSuccessMessage(`Claim #${claimId} rejected successfully!`);
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showErrorMessage(data.message || 'Failed to reject claim');
                        button.disabled = false;
                        button.innerHTML = originalText;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showErrorMessage('Error rejecting claim');
                    button.disabled = false;
                    button.innerHTML = originalText;
                });
                return false;
            }
        });

        function showSuccessMessage(message) {
            let alertDiv = document.querySelector('.alert-success');
            if (!alertDiv) {
                alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    <span class="alert-message">${message}</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                const container = document.querySelector('.container-fluid') || document.body;
                container.insertBefore(alertDiv, container.firstChild);
            } else {
                alertDiv.querySelector('.alert-message').textContent = message;
            }
        }

        function showErrorMessage(message) {
            let alertDiv = document.querySelector('.alert-danger');
            if (!alertDiv) {
                alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span class="alert-message">${message}</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                const container = document.querySelector('.container-fluid') || document.body;
                container.insertBefore(alertDiv, container.firstChild);
            } else {
                alertDiv.querySelector('.alert-message').textContent = message;
            }
        }
    </script>
}