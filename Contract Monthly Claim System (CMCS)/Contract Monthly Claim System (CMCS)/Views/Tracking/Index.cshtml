@model IEnumerable<Contract_Monthly_Claim_System__CMCS_.Models.Claim>
@{
    ViewData["Title"] = "Claim Status Tracking";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-tasks me-2 text-primary"></i>
                        Claim Status Tracking
                    </h2>
                    <p class="text-muted mb-0">Track the progress of all your claims in real-time</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="refreshStatus()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh
                    </button>
                    <a asp-controller="Claim" asp-action="Create" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>
                        New Claim
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-2 col-sm-6 mb-3">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h4 class="mb-1">@Model.Count(c => c.ClaimStatus == "Pending")</h4>
                    <small>Pending Review</small>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-sm-6 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-check fa-2x mb-2"></i>
                    <h4 class="mb-1">@Model.Count(c => c.ClaimStatus == "Approved")</h4>
                    <small>Approved</small>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-sm-6 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-cog fa-2x mb-2"></i>
                    <h4 class="mb-1">@Model.Count(c => c.ClaimStatus == "Processing")</h4>
                    <small>Processing</small>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-sm-6 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <h4 class="mb-1">@Model.Count(c => c.ClaimStatus == "Completed")</h4>
                    <small>Completed</small>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-sm-6 mb-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <i class="fas fa-times fa-2x mb-2"></i>
                    <h4 class="mb-1">@Model.Count(c => c.ClaimStatus == "Rejected")</h4>
                    <small>Rejected</small>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-sm-6 mb-3">
            <div class="card bg-secondary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-list fa-2x mb-2"></i>
                    <h4 class="mb-1">@Model.Count()</h4>
                    <small>Total Claims</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Claims List -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        All Claims
                    </h5>
                </div>
                <div class="card-body p-0">
                    @if (Model != null && Model.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Claim #</th>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Progress</th>
                                        <th>Last Updated</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var claim in Model.OrderByDescending(c => c.SubmissionDate))
                                    {
                                        <tr data-claim-id="@claim.ClaimID">
                                            <td>
                                                <strong>#@claim.ClaimID</strong>
                                            </td>
                                            <td>
                                                <div>@claim.ClaimDate.ToString("MMM dd, yyyy")</div>
                                                <small class="text-muted">Submitted: @claim.SubmissionDate.ToString("MMM dd")</small>
                                            </td>
                                            <td>
                                                <strong class="text-success">@claim.TotalAmount.ToString("C")</strong>
                                                <div class="small text-muted">@claim.HoursWorked hrs × @claim.HourlyRate.ToString("C")</div>
                                            </td>
                                            <td class="status-cell">
                                                <span class="badge @claim.StatusBadgeClass">
                                                    @claim.StatusDisplayName
                                                </span>
                                                @if (!string.IsNullOrEmpty(claim.StatusNotes))
                                                {
                                                    <div class="small text-muted mt-1">@claim.StatusNotes</div>
                                                }
                                            </td>
                                            <td class="progress-cell">
                                                <div class="progress" style="width: 100px; height: 8px;">
                                                    <div class="progress-bar @GetProgressBarClass(claim.ClaimStatus)"
                                                         role="progressbar"
                                                         style="width: @claim.StatusProgress%"
                                                         aria-valuenow="@claim.StatusProgress"
                                                         aria-valuemin="0"
                                                         aria-valuemax="100">
                                                    </div>
                                                </div>
                                                <small class="text-muted">@claim.StatusProgress%</small>
                                            </td>
                                            <td>
                                                <div>@(claim.LastUpdated?.ToString("MMM dd, HH:mm") ?? claim.SubmissionDate.ToString("MMM dd, HH:mm"))</div>
                                                <small class="text-muted">@GetTimeAgo(claim.LastUpdated ?? claim.SubmissionDate)</small>
                                            </td>
                                            <td class="actions-cell">
                                                <div class="btn-group" role="group">
                                                    <a asp-action="Details" asp-route-id="@claim.ClaimID" class="btn btn-outline-primary btn-sm">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    @if (claim.ClaimStatus == "Pending")
                                                    {
                                                        <button class="btn btn-outline-success btn-sm" onclick="updateStatus(@claim.ClaimID, 'Approved')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn btn-outline-danger btn-sm" onclick="updateStatus(@claim.ClaimID, 'Rejected')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-inbox text-muted mb-3" style="font-size: 3rem;"></i>
                            <h5 class="text-muted">No claims found</h5>
                            <p class="text-muted">Submit your first claim to start tracking.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden form for anti-forgery token -->
<form style="display: none;">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script>
        function refreshStatus() {
            location.reload();
        }

        function updateStatus(claimId, newStatus) {
            console.log(`updateStatus called: claimId=${claimId}, newStatus=${newStatus}`);

            if (newStatus === 'Rejected') {
                console.log('REJECT operation initiated for claim', claimId);
            }

            if (confirm(`Are you sure you want to change the status to ${newStatus}?`)) {
                // Find the row for this claim
                const claimRow = document.querySelector(`tr[data-claim-id="${claimId}"]`);
                console.log('Claim row found:', claimRow);

                if (!claimRow) {
                    alert('Claim row not found');
                    return;
                }

                // Show loading state
                const statusCell = claimRow.querySelector('.status-cell');
                const progressCell = claimRow.querySelector('.progress-cell');
                const actionsCell = claimRow.querySelector('.actions-cell');

                if (statusCell) {
                    statusCell.innerHTML = '<span class="badge bg-secondary">Updating...</span>';
                }

                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                console.log('Anti-forgery token:', token);

                fetch(`/Tracking/UpdateStatus?claimId=${claimId}&newStatus=${newStatus}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    }
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);
                    console.log('Status update result:', data.success, 'for', newStatus);
                    if (data.success) {
                        // Update status badge
                        if (statusCell) {
                            statusCell.innerHTML = `<span class="badge ${data.statusBadgeClass}">${data.statusDisplayName}</span>`;
                        }

                        // Update progress bar
                        if (progressCell) {
                            const progressBar = progressCell.querySelector('.progress-bar');
                            const progressText = progressCell.querySelector('.text-muted');
                            if (progressBar) {
                                // Get the correct progress percentage for the new status
                                const progressPercentage = getProgressPercentage(newStatus);

                                // Update progress bar width and percentage
                                progressBar.style.width = `${progressPercentage}%`;
                                progressBar.setAttribute('aria-valuenow', progressPercentage);

                                // Update progress bar color class based on status
                                progressBar.className = `progress-bar ${getProgressBarClass(newStatus)}`;

                                // Update progress text
                                if (progressText) {
                                    progressText.textContent = `${progressPercentage}%`;
                                }
                            }
                        }

                        // Remove approve/reject buttons
                        if (actionsCell) {
                            const approveBtn = actionsCell.querySelector('button[onclick*="Approved"]');
                            const rejectBtn = actionsCell.querySelector('button[onclick*="Rejected"]');
                            if (approveBtn) approveBtn.remove();
                            if (rejectBtn) rejectBtn.remove();
                        }

                        // Update status summary cards
                        updateStatusSummary();

                        // Show success message
                        showSuccessMessage(`Claim #${claimId} status updated to ${data.statusDisplayName}`);
                    } else {
                        alert('Error: ' + data.message);
                        // Restore original status
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while updating the status.');
                    // Restore original status
                    location.reload();
                });
            }
        }

        function updateStatusSummary() {
            // This would update the status summary cards at the top
            // For now, we'll just refresh the page to get accurate counts
            setTimeout(() => {
                location.reload();
            }, 2000);
        }

        function showSuccessMessage(message) {
            // Create and show a temporary success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        function getProgressBarClass(status) {
            switch (status) {
                case 'Pending': return 'bg-warning';
                case 'Approved': return 'bg-success';
                case 'Rejected': return 'bg-danger';
                case 'Processing': return 'bg-info';
                case 'Completed': return 'bg-primary';
                default: return 'bg-secondary';
            }
        }

        function getProgressPercentage(status) {
            switch (status) {
                case 'Pending': return 25;
                case 'Approved': return 100;  // 100% for approved
                case 'Rejected': return 100;  // 100% for rejected
                case 'Processing': return 90;
                case 'Completed': return 100;
                default: return 0;
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(function() {
            // Only refresh if no user interaction in the last 5 minutes
            if (document.visibilityState === 'visible') {
                location.reload();
            }
        }, 30000);
    </script>
}

@functions {
    string GetProgressBarClass(string status)
    {
        return status switch
        {
            "Pending" => "bg-warning",
            "Approved" => "bg-success",
            "Rejected" => "bg-danger",
            "Processing" => "bg-info",
            "Completed" => "bg-primary",
            _ => "bg-secondary"
        };
    }

    string GetTimeAgo(DateTime date)
    {
        var timeSpan = DateTime.Now - date;
        if (timeSpan.TotalDays >= 1)
            return $"{(int)timeSpan.TotalDays} days ago";
        if (timeSpan.TotalHours >= 1)
            return $"{(int)timeSpan.TotalHours} hours ago";
        if (timeSpan.TotalMinutes >= 1)
            return $"{(int)timeSpan.TotalMinutes} minutes ago";
        return "Just now";
    }
}
